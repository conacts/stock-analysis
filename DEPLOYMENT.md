# Deployment Strategy for Stock Analysis System

This document outlines the deployment strategy for hosting the Python API and automating deployments.

## ğŸ—ï¸ Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   GitHub Repo   â”‚â”€â”€â”€â–¶â”‚   Python API    â”‚â”€â”€â”€â–¶â”‚   Trigger.dev   â”‚
â”‚                 â”‚    â”‚   (Railway)     â”‚    â”‚   (Tasks)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â”‚                       â”‚                       â”‚
         â–¼                       â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CI/CD Pipeline â”‚    â”‚   PostgreSQL    â”‚    â”‚   Slack Alerts  â”‚
â”‚  (GitHub Actions)â”‚    â”‚   (Railway)     â”‚    â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸš€ Recommended Hosting Platform: Railway

**Why Railway?**

-   âœ… **Easy Python deployment** - Automatic detection of Python apps
-   âœ… **Built-in PostgreSQL** - Managed database with automatic backups
-   âœ… **GitHub integration** - Automatic deployments on push
-   âœ… **Environment management** - Separate staging/production environments
-   âœ… **Affordable pricing** - $5/month for hobby projects, scales up
-   âœ… **Zero-config deployments** - Just connect your repo
-   âœ… **Built-in monitoring** - Logs, metrics, and health checks

### Alternative Options Considered

| Platform                      | Pros                                                | Cons                                  | Cost        |
| ----------------------------- | --------------------------------------------------- | ------------------------------------- | ----------- |
| **Railway** â­                | Easy setup, PostgreSQL included, GitHub integration | Newer platform                        | $5-20/month |
| **Render**                    | Good Python support, free tier                      | Limited free tier, slower cold starts | $0-25/month |
| **Fly.io**                    | Fast global deployment, good pricing                | More complex setup                    | $5-15/month |
| **Heroku**                    | Mature platform, easy setup                         | Expensive, no free tier               | $25+/month  |
| **DigitalOcean App Platform** | Good pricing, simple                                | Limited database options              | $12+/month  |

## ğŸ“‹ Deployment Setup Guide

### Step 1: Create Railway Account and Project

1. **Sign up at [Railway.app](https://railway.app)**
2. **Connect your GitHub account**
3. **Create new project from GitHub repo**
4. **Add PostgreSQL database service**

### Step 2: Configure Environment Variables

Set these in Railway dashboard:

```bash
# Required
DATABASE_URL=postgresql://user:pass@host:port/db  # Auto-generated by Railway
ALPHA_VANTAGE_API_KEY=your_alpha_vantage_key
API_TOKEN=your_secure_api_token

# Optional but recommended
DEEPSEEK_API_KEY=your_deepseek_key
SLACK_BOT_TOKEN=your_slack_bot_token
SLACK_USER_ID=your_slack_user_id
ENVIRONMENT=production

# Note: PYTHON_API_URL is NOT needed for Railway deployment
# The API runs locally on Railway. This variable is only used by
# Trigger.dev to call your deployed API from external tasks.
```

### Step 3: Create Dockerfile

```dockerfile
# Dockerfile
FROM python:3.12-slim

WORKDIR /app

# Install uv
COPY --from=ghcr.io/astral-sh/uv:latest /uv /bin/uv

# Copy dependency files
COPY pyproject.toml uv.lock ./

# Install dependencies
RUN uv sync --frozen --no-cache

# Copy source code
COPY src/ ./src/
COPY scripts/ ./scripts/

# Expose port
EXPOSE 8000

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:8000/health || exit 1

# Run the API server
CMD ["uv", "run", "python", "-m", "src.api.server"]
```

### Step 4: Configure Railway Deployment

Create `railway.toml`:

```toml
[build]
builder = "dockerfile"

[deploy]
healthcheckPath = "/health"
healthcheckTimeout = 10
restartPolicyType = "on_failure"
restartPolicyMaxRetries = 3

[[services]]
name = "stock-analysis-api"
source = "."

[services.variables]
PORT = "8000"
```

### Step 5: Set up GitHub Actions for Automated Deployment

Create `.github/workflows/deploy.yml`:

```yaml
name: Deploy to Railway

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

jobs:
    test:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - name: Run CI tests
              run: make ci

    deploy-staging:
        runs-on: ubuntu-latest
        needs: [test]
        if: github.event_name == 'pull_request'
        steps:
            - uses: actions/checkout@v4
            - name: Deploy to Railway Staging
              uses: railway-app/railway-action@v1
              with:
                  railway-token: ${{ secrets.RAILWAY_TOKEN_STAGING }}
                  service: stock-analysis-api-staging

    deploy-production:
        runs-on: ubuntu-latest
        needs: [test]
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        steps:
            - uses: actions/checkout@v4
            - name: Deploy to Railway Production
              uses: railway-app/railway-action@v1
              with:
                  railway-token: ${{ secrets.RAILWAY_TOKEN_PROD }}
                  service: stock-analysis-api-prod

            - name: Update Trigger.dev Environment
              run: |
                  echo "ğŸš€ Production API deployed successfully"
                  echo "ğŸ“ Update PYTHON_API_URL in Trigger.dev to: https://your-app.railway.app"

    deploy-trigger:
        runs-on: ubuntu-latest
        needs: [deploy-production]
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        steps:
            - uses: actions/checkout@v4
            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
            - name: Deploy Trigger.dev Tasks
              run: |
                  npm install
                  npx trigger.dev@latest deploy --env prod
              env:
                  TRIGGER_ACCESS_TOKEN: ${{ secrets.TRIGGER_ACCESS_TOKEN }}
                  PYTHON_API_URL: https://your-app.railway.app
                  # ... other env vars
```

## ğŸ”§ Required GitHub Secrets

Add these secrets in your GitHub repository settings:

```bash
# Railway deployment tokens
RAILWAY_TOKEN_STAGING=your_staging_token
RAILWAY_TOKEN_PROD=your_production_token

# Trigger.dev
TRIGGER_ACCESS_TOKEN=your_trigger_token

# API credentials
DATABASE_URL=your_production_db_url
ALPHA_VANTAGE_API_KEY=your_api_key
API_TOKEN=your_secure_token
DEEPSEEK_API_KEY=your_deepseek_key
SLACK_BOT_TOKEN=your_slack_token
SLACK_USER_ID=your_slack_user_id

# Environment URLs (set after deployment)
STAGING_API_URL=https://your-staging-app.railway.app
PRODUCTION_API_URL=https://your-production-app.railway.app
```

## ğŸ”„ Deployment Workflow

### Automatic Deployments

1. **Pull Request** â†’ Deploy to staging environment
2. **Merge to main** â†’ Deploy to production environment
3. **Production deployment** â†’ Update Trigger.dev tasks

### Manual Deployment Commands

```bash
# Deploy to Railway manually
railway login
railway link your-project-id
railway up

# Deploy Trigger.dev tasks manually
npm run trigger:deploy:prod
```

## ğŸ“Š Monitoring and Health Checks

### Health Check Endpoint

The API includes a health check at `/health`:

```python
@app.get("/health")
async def health_check():
    return {
        "status": "healthy",
        "timestamp": datetime.now().isoformat(),
        "version": "1.0.0",
        "database": "connected",
        "services": {
            "portfolio_manager": "active",
            "stock_analyzer": "active",
            "alert_system": "active"
        }
    }
```

### Monitoring Setup

1. **Railway Dashboard** - Built-in metrics and logs
2. **Trigger.dev Dashboard** - Task execution monitoring
3. **Custom Alerts** - Slack notifications for failures
4. **Database Monitoring** - PostgreSQL performance metrics

## ğŸš¨ Rollback Strategy

### Automatic Rollback

Railway supports automatic rollbacks on health check failures.

### Manual Rollback

```bash
# Rollback to previous deployment
railway rollback

# Rollback Trigger.dev tasks
npx trigger.dev@latest deploy --env prod --version previous
```

## ğŸ’° Cost Estimation

### Railway Costs (Monthly)

-   **Hobby Plan**: $5/month

    -   512MB RAM, 1 vCPU
    -   PostgreSQL included
    -   Good for development/small production

-   **Pro Plan**: $20/month
    -   8GB RAM, 8 vCPU
    -   High availability
    -   Better for production workloads

### Total Monthly Cost

-   **Development**: ~$5/month (Railway Hobby)
-   **Production**: ~$20-30/month (Railway Pro + Trigger.dev)

## ğŸ¯ Next Steps

1. **Set up Railway account** and connect GitHub repo
2. **Configure environment variables** in Railway dashboard
3. **Add GitHub secrets** for automated deployment
4. **Test deployment pipeline** with a small change
5. **Update Trigger.dev** with production API URL
6. **Monitor deployment** and set up alerts

## ğŸ”— Useful Links

-   [Railway Documentation](https://docs.railway.app/)
-   [Railway Python Guide](https://docs.railway.app/guides/python)
-   [Trigger.dev Deployment Guide](https://trigger.dev/docs/documentation/guides/deployment)
-   [GitHub Actions Railway Integration](https://github.com/railway-app/railway-action)

This deployment strategy provides a robust, scalable, and cost-effective solution for hosting your Python API with automated CI/CD pipelines.
